<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - ConfiaChamba</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="bg-white">
  
  <!-- Navbar -->
  <nav class="border-b bg-white sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="index.html" class="flex items-center gap-2">
        <span class="text-2xl">üíº</span>
        <span class="text-xl font-bold text-gray-900">ConfiaChamba</span>
      </a>
      <div class="flex gap-4 items-center">
        <a href="index.html" class="text-gray-700 hover:text-orange-600">Inicio</a>
        <a href="create-job.html" class="text-gray-700 hover:text-orange-600">Publicar</a>
        <button onclick="logout()" class="text-gray-500 hover:text-red-600">Salir</button>
      </div>
    </div>
  </nav>

  <!-- Perfil -->
  <section class="max-w-4xl mx-auto px-4 py-8">
    
    <!-- Header del Perfil -->
    <div class="bg-orange-50 rounded-xl p-6 mb-6">
      <div class="flex items-start gap-4">
        <div id="userAvatar" class="w-20 h-20 bg-orange-500 rounded-full flex items-center justify-center text-white text-3xl font-bold flex-shrink-0">
          <!-- JS -->
        </div>
        <div class="flex-1">
          <div id="userInfo">
            <!-- JS -->
          </div>
          <button onclick="toggleEdit()" class="mt-3 text-sm text-orange-600 hover:text-orange-700 font-medium">
            ‚úèÔ∏è Editar perfil
          </button>
        </div>
      </div>
    </div>

    <!-- Formulario de Edici√≥n (oculto por defecto) -->
    <div id="editForm" class="bg-white border border-gray-200 rounded-xl p-6 mb-6 hidden">
      <h3 class="font-bold text-gray-900 mb-4">Editar mi informaci√≥n</h3>
      <form onsubmit="saveProfile(event)">
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
            <input type="text" id="editNombre" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ciudad</label>
            <input type="text" id="editCiudad"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
            <input type="tel" id="editTelefono"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500">
          </div>
        </div>
        <div class="flex gap-3">
          <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium">
            Guardar cambios
          </button>
          <button type="button" onclick="toggleEdit()" class="border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50">
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <!-- Info del Perfil -->
    <div class="bg-white border border-gray-200 rounded-xl p-6 mb-6">
      <h3 class="font-bold text-gray-900 mb-4">Mi informaci√≥n</h3>
      <div id="profileDetails" class="space-y-3">
        <!-- JS -->
      </div>
    </div>

    <!-- Mis Trabajos -->
    <div class="bg-white border border-gray-200 rounded-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-900">Mis trabajos publicados</h3>
        <a href="create-job.html" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium text-sm">
          + Publicar nuevo
        </a>
      </div>
      
      <div id="userJobs" class="space-y-3">
        <!-- JS -->
      </div>
      
      <div id="loadingJobs" class="text-center py-8 hidden">
        <p class="text-gray-500">Cargando...</p>
      </div>
      
      <div id="noJobs" class="text-center py-8 hidden">
        <p class="text-gray-600 mb-2">Todav√≠a no has publicado nada</p>
        <a href="create-job.html" class="text-orange-600 font-medium hover:underline">
          Publica tu primer trabajo aqu√≠
        </a>
      </div>
    </div>
  </section>

  <script>
    let currentUser = null;

    async function loadProfile() {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));

      if (!token || !user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;

      // Avatar
      document.getElementById('userAvatar').textContent = user.nombre.charAt(0).toUpperCase();

      // Info b√°sica
      const rating = parseFloat(user.promedio_calificacion || 0).toFixed(1);
      document.getElementById('userInfo').innerHTML = `
        <h2 class="text-2xl font-bold text-gray-900">${user.nombre}</h2>
        <p class="text-gray-600">${user.email}</p>
        <div class="flex gap-4 mt-2 text-sm">
          <span class="text-gray-700">‚≠ê ${rating}</span>
          <span class="text-gray-700">‚Ä¢ ${user.total_trabajos || 0} trabajos</span>
          ${user.ciudad ? `<span class="text-gray-700">‚Ä¢ üìç ${user.ciudad}</span>` : ''}
        </div>
      `;

      // Detalles
      document.getElementById('profileDetails').innerHTML = `
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-gray-600">Email</span>
          <span class="font-medium text-gray-900">${user.email}</span>
        </div>
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-gray-600">Ciudad</span>
          <span class="font-medium text-gray-900">${user.ciudad || 'No especificada'}</span>
        </div>
        <div class="flex justify-between py-2 border-b border-gray-100">
          <span class="text-gray-600">Tel√©fono</span>
          <span class="font-medium text-gray-900">${user.telefono || 'No agregado'}</span>
        </div>
        <div class="flex justify-between py-2">
          <span class="text-gray-600">Trabajos realizados</span>
          <span class="font-medium text-gray-900">${user.total_trabajos || 0}</span>
        </div>
      `;

      loadUserJobs();
    }

    function toggleEdit() {
      const editForm = document.getElementById('editForm');
      const isHidden = editForm.classList.contains('hidden');
      
      if (isHidden) {
        // Llenar el formulario
        document.getElementById('editNombre').value = currentUser.nombre;
        document.getElementById('editCiudad').value = currentUser.ciudad || '';
        document.getElementById('editTelefono').value = currentUser.telefono || '';
        editForm.classList.remove('hidden');
      } else {
        editForm.classList.add('hidden');
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      const token = localStorage.getItem('token');

      const data = {
        nombre: document.getElementById('editNombre').value,
        ciudad: document.getElementById('editCiudad').value,
        telefono: document.getElementById('editTelefono').value
      };

      try {
        const response = await fetch(`${CONFIG.API_ENDPOINT}/users/profile`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Error al actualizar');

        const result = await response.json();
        localStorage.setItem('user', JSON.stringify(result.user));
        
        alert('‚úì Perfil actualizado');
        toggleEdit();
        loadProfile();
      } catch (error) {
        alert('Error al guardar: ' + error.message);
      }
    }

    async function loadUserJobs() {
      const token = localStorage.getItem('token');
      const userJobs = document.getElementById('userJobs');
      const noJobs = document.getElementById('noJobs');
      const loadingJobs = document.getElementById('loadingJobs');

      loadingJobs.classList.remove('hidden');
      userJobs.innerHTML = '';
      noJobs.classList.add('hidden');

      try {
        const response = await fetch(`${CONFIG.API_ENDPOINT}/jobs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const allJobs = await response.json();
        const myJobs = allJobs.filter(job => job.user_id === currentUser.id);

        loadingJobs.classList.add('hidden');

        if (myJobs.length === 0) {
          noJobs.classList.remove('hidden');
          return;
        }

        const categoryEmoji = {
          'plomeria': 'üîß',
          'electricidad': '‚ö°',
          'carpinteria': 'ü™ö',
          'pintura': 'üé®',
          'limpieza': 'üßπ',
          'jardineria': 'üå±',
          'construccion': 'üèóÔ∏è'
        };

        userJobs.innerHTML = myJobs.map(job => `
          <div class="border border-gray-200 rounded-lg p-4 hover:border-orange-300 transition">
            <div class="flex justify-between items-start gap-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">${categoryEmoji[job.categoria] || 'üíº'}</span>
                  <h4 class="font-bold text-gray-900">${job.titulo}</h4>
                </div>
                <p class="text-sm text-gray-600 mb-2">${job.descripcion.substring(0, 120)}${job.descripcion.length > 120 ? '...' : ''}</p>
                <div class="flex gap-2 flex-wrap">
                  <span class="text-xs bg-gray-100 px-2 py-1 rounded">${job.categoria}</span>
                  <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-medium">$${job.precio}</span>
                  ${job.ciudad ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">üìç ${job.ciudad}</span>` : ''}
                </div>
              </div>
              <div class="flex flex-col gap-2">
                <button onclick="deleteJob('${job.id}')" class="text-red-600 hover:text-red-700 text-sm">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error:', error);
        loadingJobs.classList.add('hidden');
        userJobs.innerHTML = '<p class="text-red-500 text-center py-4">Error al cargar trabajos</p>';
      }
    }

    async function deleteJob(jobId) {
      if (!confirm('¬øSeguro que quieres borrar este trabajo?')) return;

      const token = localStorage.getItem('token');

      try {
        const response = await fetch(`${CONFIG.API_ENDPOINT}/jobs/${jobId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Error al eliminar');

        alert('‚úì Trabajo eliminado');
        loadUserJobs();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function logout() {
      if(confirm('¬øSeguro que quieres salir?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      }
    }

    loadProfile();
  </script>
</body>
</html>